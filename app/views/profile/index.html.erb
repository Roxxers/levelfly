<div id="avatar" class="avatar_portal">
  <img id="background" class="avatar">
  <img id="body" class="avatar">
  <img id="hat_back" class="avatar">
  <img id="hair_back" class="avatar">
  <img id="shoes" class="avatar">
  <img id="bottom" class="avatar">
  <img id="necklace" class="avatar">
  <img id="top" class="avatar">
  <img id="head" class="avatar">
  <img id="earrings" class="avatar">
  <img id="facial_marks" class="avatar">
  <img id="facial_hair" class="avatar">
  <img id="makeup" class="avatar">
  <img id="glasses" class="avatar">
  <img id="hair" class="avatar">
  <img id="hat" class="avatar">
  <img id="prop" class="avatar">
</div>

<div id="controls" class="avatar_stats">
  <p><input id="full_name" name="full_name" class="input" readonly="true"></p>
  <p><input id="school" name="school" class="input" readonly="true"></p>
  <p><input id="major" name="major" class="input" readonly="true"></p>
</div>

<div id="show_controls" class="avatar_controls">
  <input id="modify" name="modify" type="button" class="clickable button" value="MODIFY">
</div>

<div id="edit_controls" class="avatar_controls">
  <input id="save" name="modify" type="button" class="clickable button" value="SAVE">
</div>

<div id="wardrobe_options" class="wardrobe_options">
  <div id="wardrobe_categories" class="wardrobe_categories">
    <div id="category_head" class="wardrobe_item clickable" value="head">Head</div>
    <div id="category_body" class="wardrobe_item clickable" value="body">Body</div>
    <div id="category_legs" class="wardrobe_item clickable" value="legs">Legs</div>
    <div id="category_feet" class="wardrobe_item clickable" value="feet">Feet</div>
    <div id="category_prop" class="wardrobe_item clickable" value="prop">Prop</div>
  </div>

  <div id="wardrobe_subcategories" class="wardrobe_subcategories">
    <div id="subcategory_0" class="wardrobe_item clickable"></div>
    <div id="subcategory_1" class="wardrobe_item clickable"></div>
    <div id="subcategory_2" class="wardrobe_item clickable"></div>
    <div id="subcategory_3" class="wardrobe_item clickable"></div>
    <div id="subcategory_4" class="wardrobe_item clickable"></div>
  </div>
</div>

<div>
<% if user_signed_in? %>
  <%= link_to('Logout', destroy_user_session_path, :method => :delete) %>
<% end %>
</div>

<script type="text/javascript">
<!--

var _wardrobeItems;
var _profile;
var _avatar;
var _currentSubCategory;
var _major;
var _school;

$(window).load(function() {
  // CUSTOMIZE AVATAR
  $("#modify").click(function() {
    if (_wardrobeItems == undefined) {
      // Fillup the wardrobe for the first time
      $.getJSON("/profile/edit",
         function(data){
           for (i=0; i<data.length; i++) {
             if (data[i].depth == 0) {
               $("#category_"+data[i].item_type).attr("value", data[i].id)
             }
           }
           _wardrobeItems = data;
         });  
    }

    $("#show_controls").hide();
    $("#edit_controls").show();
    $("#wardrobe_options").show();
    $("#full_name").removeAttr("readonly");
    $("#full_name").val("Enter Full Name");
    $("#full_name").focus();
    $("#full_name").select();
  })

  // SAVE AVATAR
  $("#save").click(function() {
    if (_school != undefined) {
      _profile.school_id = _school.id;
    }
    if (_major != undefined) {
      _profile.major_id = _major.id;
    }
    $.getJSON("/profile/save", { id: _profile.id, profile: _profile, avatar: _avatar },
       function(data){
         _profile = data.profile;
         _avatar = data.avatar;
         
         $("#show_controls").show();
         $("#edit_controls").hide();
         $("#wardrobe_options").hide();
         $("#full_name").attr("readonly", "true");
       });
  })

  // Finish editing a field
  $(".input").blur(function() {
    _profile.full_name = $("#full_name").val();
  });
  
  // Click a wardrobe option
  $(".wardrobe_item").click(function() {
    image_file = $(this).attr("image_file");
    if (image_file != undefined) {
      // Clicked on an option that can be applied
      item_type = $(this).attr("item_type");
      if (image_file == _avatar[item_type]) {
        // Already applied? Remove this item
        image_file = "null";
      }
      // Display the item on the avatar
      $("#"+item_type).attr("src", "/images/wardrobe/"+image_file+".png");
      _avatar[item_type] = image_file
      // Check if there is a back layer
      if (item_type == "hair" || item_type == "hat") {
        item_type_back = item_type + "_back";
        _avatar[item_type_back] = image_file + "_back";
        $("#"+item_type_back).attr("src", "/images/wardrobe/"+image_file+"_back.png");
      }
      showSubCategory(_currentSubCategory);

    } else {
      _currentSubCategory = $(this).attr("value");
      resetSubCategory();
      showSubCategory(_currentSubCategory);
      $("#wardrobe_subcategories").show();
    }
  });
  
  $.getJSON("/profile/show",
     function(data){
       _profile = data.profile;
       _avatar = data.avatar;
       _major = data.major;
       _school = data.school;
       showAvatar();
       if (data.new_profile == true) {
         acceptCode();
       }
     });  

  if ($("#full_name").val() == "") {
   $("#full_name").attr("readonly", "true");
   $("#edit_controls").hide();
   $("#wardrobe_options").hide();
   $("#wardrobe_subcategories").hide();
  }

});

function resetSubCategory() {
  for (i=0; i<5; i++) {
    $("#subcategory_"+i).html("");
    $("#subcategory_"+i).removeAttr("value");
    $("#subcategory_"+i).removeAttr("image_file");
    $("#subcategory_"+i).removeAttr("item_type");
  }
}

function showSubCategory(id) {
  idx = 0;
  for (i=0; i<_wardrobeItems.length; i++) {
    if (_wardrobeItems[i].parent_item_id == id) {
      $("#subcategory_"+idx).html(_wardrobeItems[i].name);
      $("#subcategory_"+idx).attr("value", _wardrobeItems[i].id);
      // Set the image file
      item_type = _wardrobeItems[i].item_type;
      image_file = _wardrobeItems[i].image_file;
      if (image_file != undefined) {
        $("#subcategory_"+idx).attr("image_file", _wardrobeItems[i].image_file);
      }
      // Set the item type
      if (item_type != undefined) {
        $("#subcategory_"+idx).attr("item_type", item_type);
      }
      // Is the item currently used?
      if (image_file != null && image_file == _avatar[item_type]) {
        $("#subcategory_"+idx).addClass("selected");
      } else {
        $("#subcategory_"+idx).removeClass("selected");
      }
      idx = idx + 1;
    }
  }
}

function showAvatar() {
  $("#full_name").val(_profile.full_name);
  if (_major != undefined) {
    $("#major").val(_major.name);
  }
  if (_school != undefined) {
    $("#school").val(_school.code);
  }
  $("#background").attr("src", "/images/wardrobe/"+_avatar.background+".png");
  $("#body").attr("src", "/images/wardrobe/"+_avatar.body+".png");
  $("#hat_back").attr("src", "/images/wardrobe/"+_avatar.hat_back+".png");
  $("#hair_back").attr("src", "/images/wardrobe/"+_avatar.hair_back+".png");
  $("#shoes").attr("src", "/images/wardrobe/"+_avatar.shoes+".png");
  $("#bottom").attr("src", "/images/wardrobe/"+_avatar.bottom+".png");
  $("#necklace").attr("src", "/images/wardrobe/"+_avatar.necklace+".png");
  $("#top").attr("src", "/images/wardrobe/"+_avatar.top+".png");
  $("#head").attr("src", "/images/wardrobe/"+_avatar.head+".png");
  $("#earrings").attr("src", "/images/wardrobe/"+_avatar.earrings+".png");
  $("#facial_marks").attr("src", "/images/wardrobe/"+_avatar.facial_marks+".png");
  $("#facial_hair").attr("src", "/images/wardrobe/"+_avatar.facial_hair+".png");
  $("#makeup").attr("src", "/images/wardrobe/"+_avatar.makeup+".png");
  $("#glasses").attr("src", "/images/wardrobe/"+_avatar.glasses+".png");
  $("#hair").attr("src", "/images/wardrobe/"+_avatar.hair+".png");
  $("#hat").attr("src", "/images/wardrobe/"+_avatar.hat+".png");
  $("#prop").attr("src", "/images/wardrobe/"+_avatar.prop+".png");
}

function acceptCode() {
  $.get('/profile/accept_code', function(data) {
    $('#dialog').html(data);
  })
  .success(function() { showDialog(true); });
}

//-->
</script>
<div id="sidebar_right">
  <div class="task_side_buttons">
    <a href="javascript:void(0)" name="btn_course" id="btn_course" class="big_orange_btn">SAVE</a>
    <% if @course%>
      <a href="javascript:void(0)" name="menu_btn_addfile" id="menu_btn_addfile" class="big_blue_btn">ADD FILE</a>
      <a href="javascript:void(0)" name="btn_category_remove" id="btn_category_remove" class="big_blue_btn">REMOVE</a>
    <% end %>
    <input type="hidden" name="hdn_is_page_change" id="hdn_is_page_change" value="<%=@course ? false : true %>" />
  </div><!-- crud_level -->
</div>
<div class="course_content">
    <div class="course_board_left">
      <div class="course_board_right">
        <div class="course_board_center">
          <div class="texture_board">
            <div class="course_pad_top"> </div>
            <div class="course_pad">
              <!-- tabs-->
              
            <div class="course_tabs menu_container" align="right">
              <a href="javascript:void(0)"  id="menu1" value="1" class="tab_open" ><span class="task_tab">Course</span></a>
              <a href="javascript:void(0)"  id="menu2" value="2" class="tab_close" ><span class="task_tab">Setup</span></a>
              <a href="javascript:void(0)"  id="menu3" value="3" class="tab_close"><span class="task_tab">Forums</span></a>
              <a href="javascript:void(0)"  id="menu4" value="4" class="tab_close"><span class="task_tab">Files</span></a>
              <a href="javascript:void(0)"  id="menu5" value="5" class="tab_close" ><span class="task_tab">Stats</span></a>
            </div>
                      
            <div class="course_tab_content">
              <div class="right_form_containerr" id="load_data">
                  <!-- Data load here-->     
                <% if defined?(course_new) && course_new == true %>
                  <%= render :partial=>"course/setup" %>
                <% else %>
                  <%= render :partial=>"course/show_course" %>
                <% end %>
              </div>
              <input type="hidden" name="course_id" id="course_id_hdn" value="<%=@course.id if @course%>" />
              <input type="hidden" name="wall_id" id="course_wall_id_hdn" value="<%= @wall.id if @wall && !@wall.nil? %>" />
              <input type="hidden" name="school_id" id="course_school_id_hdn" value="<%= @profile.school_id %>" />
            </div>
            <div class="clear"></div>
			  </div>
            </div>
          </div>
        </div>
    </div>
 </div>
<script type="text/javascript">
<!-- 
jStorage.flush();
//For dynamic added nodes
var _counterPeople = 2;
var _counterOutcome = 2;
var _counterCategory = 2;
var _outcomesObject = [];
var _categoriesObject = [];
var _outcomes_descrObject = [];
var _categories_persentObject = [];
var _outcomes_shareObject = [];
//set outcomes to offline storage
$.each($('input[name="outcomes[]"], input[name="people_id[]"], input[name="categories[]"]'), function() {
  setStorage($(this).attr('id'), $(this).val());
});

//set storage on load while view of course
if($("#course_name").val()!="") {setStorage("course_name", $("#course_name").val());} 
else {setStorage("course_name", "Course Name");}
if($("#course_descr").val()!="") {setStorage("course_descr", $("#course_descr").val());} else {setStorage("course_descr", "New Course Description");}
if($("#course_code").val()!="") {setStorage("course_code", $("#course_code").val());} 
else {setStorage("course_code", "Course Code");}
if($("#course_section").val()!="") {setStorage("course_section", $("#course_section").val());} 
else {setStorage("course_section", "Section");}


$(document).ready(function(){
  /*$("#menu5").hide();
  <% if @course_owner %>
  var current_user = <%= user_session[:profile_id] %>
  var course_owner = <%= @course_owner.profile_id %>
  if(current_user == course_owner)
  {
     $("#div_1").addClass("tab_content hide");
     $("#div_1").removeClass("form_container1");
     $("#div_2").addClass("form_container1");
     $("#div_2").removeClass("tab_content hide");
     $("#menu1").removeClass("tab_open");
     $("#menu1").addClass("tab_close");
     $("#menu2").removeClass("tab_close");
     $("#menu2").addClass("tab_open");
     $("#menu5").hide();
  } 
  else
  {
     $("#div_1").addClass("form_container1");
     $("#div_1").removeClass("tab_content hide");
     $("#div_2").addClass("tab_content hide");
     $("#div_2").removeClass("form_container1");
     $("#menu2").hide();
     $("#menu5").show();
  }  
  <%else%>
  
     $("#div_1").addClass("tab_content hide");
     $("#div_1").removeClass("form_container1");
     $("#div_2").addClass("form_container1");
     $("#div_2").removeClass("tab_content hide");
     $("#menu1").removeClass("tab_open");
     $("#menu1").addClass("tab_close");
     $("#menu2").removeClass("tab_close");
     $("#menu2").addClass("tab_open");
     $("#menu5").hide();
     
  <% end %>
  */
  $(".field_prompt").hide();
  
  // Field instructions
  $(".prompted").focus(function() {
    prompt = $(this).attr("prompt");
    $("#"+prompt).show();
  });
  $(".prompted").blur(function() {
    prompt = $(this).attr("prompt");
    $("#"+prompt).hide();
  });
  
  //Toggle Tabs
  /*course_id = $("#course_id_hdn").val();          
  var data = {id:course_id};
  $("#load_data").load("/course/show_course", {type: 'POST',data:data},function(response, status, xhr) {
    if(response)
    {
       $("#load_data").html(response); 
    }
    if (status == "error") {
       var msg = "Sorry but there was an error: ";
       alert(msg);
    }
  });*/
   
   $(".menu_container").delegate('a', 'click', function(){
    showSpinner(true);
    idx = $(this).attr("value");
    course_id = $("#course_id_hdn").val();          
      var data = {value:idx,id:course_id};
      $("#load_data").load("/course/show_course",data, function(response, status, xhr) {
      if(response)
      {
        $("#load_data").html(response); 
        showSpinner(false);
      }
      if (status == "error")
      {
        var msg = "Sorry but there was an error: ";
        alert(msg);
      }
      });

      is_page_change = $("#hdn_is_page_change").val();
      if(is_page_change == "true") {
        save_course(this.id);
      }
      
      
   /* $(".menu_container a").removeClass("active");
    $(this).addClass("active");
    for(i=0;i<7;i++){
      //---- Set all menu as De-Selected
      if(document.getElementById("menu"+(i+1))!=null){
        document.getElementById("menu"+(i+1)).className = "tab_close";
      }
      //----
      if(idx != i){
        $("#div_"+i).hide();
      }
    }
    if(idx == 2) {
      $("#btn_outcome_remove").fadeIn();
      $("#btn_category_remove").fadeIn();
    } else {
      $("#btn_outcome_remove").fadeOut();
      $("#btn_category_remove").fadeOut();
    }
    
    if(idx == 4) {
      $("#menu_btn_addfile").fadeIn();
    } else {
      $("#menu_btn_addfile").fadeOut();
    }
     //---- Selected menu will highlighted
    
    document.getElementById("menu"+idx).className = "tab_open";
    $("#div_"+idx).fadeIn();
    is_page_change = $("#hdn_is_page_change").val();
    if(is_page_change == "true") {
      save_course(this.id);
    }*/
  });
  
      //Add File by button
      
      $("#menu_btn_addfile").click(function(){
         $("#confirm_upload").show();
         $("#show_file_data").hide();
      });
  
     /* var file_uploader = new plupload.Uploader({
        runtimes : 'html5',
        browse_button : 'pickfiles',
        container: 'pickfiles',
        max_file_size : '10mb',
        url : '/course/add_file',
        multipart_params: {
          'authenticity_token' : token,  //For csrf-authentication
          'school_id' : $("#course_school_id_hdn").val(),
          'id' : $("#course_id_hdn").val()
        }
      });

      file_uploader.init();
      
      file_uploader.bind('FilesAdded', function(up, files) {
         showSpinner(true);
         file_uploader.start();
      });

      file_uploader.bind('UploadProgress', function(up, file) {
        $('#show_file_uploading').html('<center>Uploading..</center>');
      });

     file_uploader.bind('FileUploaded', function(up, file, info) {
        var obj = jQuery.parseJSON( info.response);
        $("#show_file_data").show();
        $("#file_task").text(obj.attachment.resource_file_name);
        $("#file_uploaded_by").text(obj.attachment.id);
        $("#file_uploaded_on").text(obj.attachment.created_at);
        $("#file_revision").text(obj.attachment.id);
        $('#show_file_uploading').html("");
        showSpinner(false);
    });*/
        
        
   
  //Submit data
  $("#btn_course").unbind('click').bind('click', function(){
    save_course(this.id);
  });
  
  $("#btn_task").click(function(data){
   var course_id=$("#course_id_hdn").val();
   var dataString = {course_id:course_id};
   showSpinner(true);
   $.ajax({  
        type: "GET",  
        url: "/task/view_task",  
        data: dataString,
        success: function(data) {
		$("#container").html(data);
			showSpinner(false);
        },
        error: function()
		{
			alert("An Error has occured");
			showSpinner(false);
		},
      }); 
    });
   
  //For updating outcomes (in course view screen)
  $('input[name="loaded_outcomes[]"]').unbind('blur').bind('blur', function(){
    var outcome_id = $(this).attr('rel');
    var outcome = $(this).val();
    var dataString = 'outcome_id=' + outcome_id + '&outcome=' + outcome;
    if(outcome_id) {
      showSpinner(true);
      //alert (dataString);return false;
      $.ajax({  
        type: "POST",  
        url: "/course/update_course_outcomes",  
        data: dataString,
        error: function(){alert("Error");showSpinner(false);},
        success: function(data) {
          if (data) {
            // TO DO
          } else {
            alert("ERROR");
          }
          showSpinner(false);
        }
      });  
      return false; 
    }
  });
  
  //For updating categories (in course view screen)
  $('input[name="loaded_categories[]"]').unbind('blur').bind('blur', function(){
    var category_id = $(this).attr('rel');
    var category = $(this).val();
    var dataString = 'category_id=' + category_id + '&category=' + category
    if(category_id) {
      showSpinner(true);
      //alert (dataString);return false;
      $.ajax({  
        type: "POST",  
        url: "/course/update_course_categories",  
        data: dataString,
        success: function(data) {
          if (data) {
           // TO DO
          } else {
            alert("ERROR");
          }
          showSpinner(false);
        }
      });  
      return false; 
    }
  });
  
  //List people (participants)
  $("#btn_add_people").click(function() {
    course_people = $("#add_course_people").val();
    school_id = $("#course_school_id_hdn").val();
    dataString = {school_id:school_id, search_text:course_people};
    if (course_people!="") {
      if(school_id) {
        showSpinner(true);
        $("#course_participant_list").show();
        $("#course_participant_list_inner").html("Loading...");
        $.ajax({  
          type: "POST",  
          url: "/course/get_participants",  
          data: dataString,
          success: function(data) {
            if (data) {
              $("#course_participant_list_inner").html(data);
            } else {
              alert("ERROR");
            }
            showSpinner(false);
          }
        });
      }
    } else {
      alert("Please insert participant name");
    }
  });
  
  //Add people (participant) to course
  $("#course_participant_list").delegate(".people_node li", "click", function(){
    showSpinner(true);
    course_id = $("#course_id_hdn").val();
    profile_id = $(this).attr("id");
    profile_name = $(this).text();
    node_class = $(this).attr("class");
    dataString = {course_id:course_id, profile_id:profile_id};
    if (profile_id && course_id) {
      $.ajax({  
        type: "POST",  
        url: "/course/add_participant",  
        data: dataString,
        dataType: "json",
        success: function(data) {
          if (data.status) {
            participant_node = $('<li id="'+ profile_id + '" class="'+node_class+'"></li>');
            participant_node.className = node_class;
            participant_node.id = profile_id;
            partcipant_html = '<div class="people_name">' + profile_name + '</div>';
            partcipant_html += '<div class="people_delete"><a href="javascript:void(0)" rel="'+profile_id+'">Delete</a></div>';
            participant_node.append(partcipant_html);
            $("#course_people ul").append(participant_node);
            $("#course_participant_list").hide();
            $("#hdn_is_page_change").val(true);
          } else {
            if(data.already_added) {
              alert("This participant is already added to this course!!");
            } else {
              alert("ERROR");
              $("#course_participant_list").hide();
            }
          }
          showSpinner(false);
        }
      }); 
    }
  });
  
  //Delete participant 
  $(".people_node li").delegate(".people_delete a", "click", function(){
    showSpinner(true);
    profile_id = $(this).attr("rel");
    course_id = $("#course_id_hdn").val(); 
    dataString = {course_id:course_id, profile_id:profile_id};
    if(profile_id) {
      $.ajax({  
        type: "POST",  
        url: "/course/delete_participant",  
        data: dataString,
        success: function(data) {
          if (data) {
            $("#"+profile_id).remove();
          } else {
            alert("ERROR");
          }
          showSpinner(false);
        }
      });
    }
  });
  
  //Remove outcome nodes
  $(".outcome_del").click(function(){
    showSpinner(true);
    outcome_id = $(this).attr('rel');
    $("#outcome_div_"+outcome_id).remove();
    var dataString = 'outcomes='+outcome_id;
    $.ajax({  
       type: "POST",  
       url: "/course/remove_course_outcomes",  
       data: dataString,
       dataType:"json",
       success: function(data) {
         showSpinner(false);
       }
    });
  });
  
  //Remove outcome nodes
  $(".files_del").click(function(){
    showSpinner(true);
    file_id=$(this).attr("rel");
    $("#filename_"+file_id).remove();
    var dataString = 'files='+file_id;
    $.ajax({
       type: "POST",  
       url: "/course/remove_course_files",  
       data: dataString,
       dataType:"json",
       success: function(data) {
         showSpinner(false);
       }
    });
  });
  
  $(".files_download").click(function(){
    $("#file_download").show();
  });
  
  //Remove category nodes
  $("#btn_category_remove").unbind('click').bind("click", function(){
    showSpinner(true);
    var category_id = []
    i = 0
    $("input[name='chk_categories[]']").each(function(){
      if(this.checked) {
        id = $(this).attr('id');
        category_id[i] = id;
        i++;
        $("#category_div_"+id).remove();
      }
    });
    
    var dataString = 'categories='+category_id;
    $.ajax({  
      type: "POST",  
      url: "/course/remove_course_categories",  
      data: dataString,
      dataType:"json",
      success: function(data) {
        showSpinner(false);
      }
    });  
  });
  
  //Post Message
  $('.right_form_containerr').delegate('.sbmt_msg', 'click', function(){
    showSpinner(true);
    parent_id = $(this).attr("id");
    parent_type = $(this).attr("rel");
    text = $(this).attr("title");
    message = $("#"+text).val();
    if(message.trim().length==0){
      alert('Please enter message...');
      showSpinner(false);
      return;
    }
    var dataString = {parent_id:parent_id, parent_type:parent_type, content: message};
    //alert(dataString.content);return false;
    $.ajax({  
      type: "POST",  
      url: "/message/save",  
      data: dataString,
      success: function(data) {
        $("#"+text).val("");
        if(parent_type=="Course") {
          $("#message_wrapper").prepend(data);
          $("#msg_input").fadeOut();
        } else if (parent_type=="Message") {
          $("#post_comment_"+parent_id).hide();
          $("#messsage_box_"+parent_id).append(data);
        }
        showSpinner(false);
      }
    });  
  });
  
  //Like/Unlike a message or comment
  $('.message_wrapper').delegate('.like', 'click', function(){
    showSpinner(true);
    if(this.id){
      action = $(this).attr('rel');
      controller = this;
      $.ajax({  
        type: "POST",  
        url: "/message/"+action,
        dataType: 'json',
        data: {message_id:this.id},
        success: function(data) {
          if (data) {
            $(controller).attr('rel',data.action);
            $(controller).text(data.action.toUpperCase());
            $('#count_'+controller.id).html(data.count);
          }
          showSpinner(false);
        }
      });
    }
  });
  
  //Upload doc file
});

//Add an outcome
function addOutcome() {
   addNode('outcome');
   $("#hdn_is_page_change").val(true);
}

//For outcomes hover div
$(".outcome_div").hover(
  function () {
    id = $(this).attr("id");
    $("#"+id+" #on_hover").show();
  }, 
  function () {
    id = $(this).attr("id");
    $("#"+id+" #on_hover").hide();
  }
);

// For Download
$(".download_files").click(function(){
  alert("download");
});
//For files hover div
$(".file_content").hover(
  function () {
    id = $(this).attr("id");
    $("#"+id+" #files_hover").show();
  }, 
  function () {
    id = $(this).attr("id");
    $("#"+id+" #files_hover").hide();
  }
);


//Add a category
function addCategory() {
  addNode('category');
  $("#hdn_is_page_change").val(true);
}

//Save course
function save_course(channel) {
  //Get data from offline storage
  course_id = $("#course_id_hdn").val();
  course = getStorage("course_name");
  descr = getStorage("course_descr");
  code = getStorage("course_code");
  section = getStorage("course_section");
  school_id = $("#course_school_id_hdn").val();
  wall_id = $("#course_wall_id_hdn").val();
  
  rating_low = getStorage("course_rating_low");
  rating_medium = getStorage("course_rating_medium");
  rating_high = getStorage("course_rating_high");
  task_low = getStorage("task_low");
  task_medium = getStorage("task_medium");
  task_high = getStorage("task_high");
  
  
  //get outcomes from offline storage
  k = 0;
  $.each($('input[name="outcomes[]"]'), function() {
    _outcomesObject[k] = $(this).val();
    k++;
  });

  //get outcomes description from offline storage
  i = 0;
  $.each($('textarea[name="outcomes_descr[]"]'), function() {
    _outcomes_descrObject[i] = $(this).val();
    i++;
  });
  
  //get categories from offline storage
  l = 0;
  $.each($('input[name="categories[]"]'), function() {
    _categoriesObject[l] = $(this).val();
    l++;
  });
  //get categories percent value from offline storage
  m = 0;
  $.each($('input[name="loaded_category_values[]"]'), function() {
    _categories_persentObject[m] = $(this).val();
    m++;
  });
  
  n = 0;
  $.each($('input[name="outcomes_share[]"]'), function() {
    _outcomes_shareObject[n] = $(this).is(":checked");
    n++;
  });
 
  var dataString = 'id='+ course_id +'&course='+ course + '&descr=' + descr + '&code=' + code + '&section=' + section + '&school_id=' + school_id + '&outcomes=' + _outcomesObject + '&outcomes_descr=' + _outcomes_descrObject + '&categories=' + _categoriesObject + '&wall_id=' +wall_id + '&percent_value=' +_categories_persentObject+ '&outcome_share='+_outcomes_shareObject+'&rating_low=' +rating_low + '&rating_medium=' +rating_medium + '&rating_high=' +rating_high + '&task_low=' +task_low + '&task_medium=' +task_medium + '&task_high=' +task_high; 

  //alert(dataString);  return false;
   
  showSpinner(true);
  $.ajax({
    type: "POST",  
    url: "/course/save",  
    data: dataString,
    dataType:"json",
    success: function(data) {
      if (data) {
        $("#course_id_hdn").val(data.course.id);
        $("#course_name").val(data.course.name);
        $("#course_code").val(data.course.code);
        $("#course_section").val(data.course.section);
        $("#course_name").attr("readonly","readonly");
        $("#course_code").attr("readonly","readonly");
        $("#course_section").attr("readonly","readonly");
        if(channel=="btn_course") {
          $("#container").load('/course/index', function(){
            showSpinner(false);
          });
        } else {
          showSpinner(false);
        }
        $("#hdn_is_page_change").val(false);
      } else {
        alert("ERROR");
        showSpinner(false);
      }
    }
  });  
  return false;  
}

//Adding text field nodes for peoples, outcomes, categories
function addNode(element) {
  if(element=="people") {
    var newNode = $(document.createElement('div')).attr("id", 'people_node_div' + _counterPeople);
    newNode.css("marginTop" , "20px");
    newNode.html('<input type="text" name="add_people_email[]" value="Type in email to add" class="medium node" id="add_people_email_' + _counterPeople + '" />');
    newNode.appendTo("#add_people_container");
    _counterPeople++;
  } else if(element=="outcome"){
    var newNode = $(document.createElement('div')).attr("id", 'outcome_node_div' + _counterOutcome);
    newNode.html('<div style="margin-top:5px; height:48px; width:500px;" class="outcome_div"><div style="float:left; margin-left:10px; height:45px;" > <input type="checkbox" id="outcomes_'+_counterOutcome+'" class="dd_select brown_bg" name="outcomes_share[]" /><input type="text" name="outcomes[]" id="outcomes_' + _counterOutcome + '" value="" class="dd_select brown_bg medium"  /></div><div style="float:left; margin-left:10px;"><textarea class="small dd_input brown_bg" style="width:260px; height:45px;" name="outcomes_descr[]" id="outcomes_descr_' + _counterOutcome + '""></textarea></div></div>');
    newNode.appendTo("#add_outcome_container");
    _counterOutcome++;
  } else if(element=="category"){
    var newNode = $(document.createElement('div')).attr("id", 'category_node_div' + _counterCategory);
    $('#add_category_container div').css("height","30px");
    newNode.html('<input type="text" name="categories[]" id="categories_' + _counterCategory + '" value="" class="dd_select brown_bg medium"  />&nbsp;&nbsp;&nbsp;<input type="text" id="loaded_category_values_'+_counterCategory+'" name="loaded_category_values[]" value="" class="dd_select brown_bg medium" />');
    newNode.appendTo("#add_category_container");
    _counterCategory++;
  }
}
-->
</script>
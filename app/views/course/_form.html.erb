<div class="screen_title">
  VIEW COURSE
</div>
<div class="content_wrapper">
  <div class="content_container">
    <form name="frm_task" id="frm_task" enctype="multipart/form-data">
      <div id="div_1" class="form_container">
        <div class="left_form_container">
          <div class="thumbnail_large" id="course_image">
            <img id="course_thumb" src='<%= @course && @course.image_file_name ? @course.image.url : "/images/majors/ACCOUNTING.png" %>' alt="Course image" />
          </div>
        </div>
        <div class="right_form_container">
          <div class="frm_input">
            <span>Course</span>
            <input type="text" name="course_name" id="course_name" class="large" value="<%=@course.name if @course%>" onBlur='javascript:setStorage("course_name", $(this).val()); $("#hdn_is_page_change").val(true);' />
          </div>
          <div class="frm_input">
            <span>Description</span>
            <textarea name="course_descr" id="course_descr" rows="10" onBlur='javascript:setStorage("course_descr", $(this).val());$("#hdn_is_page_change").val(true);'><%=@course.descr if @course%></textarea>
          </div>
          <div class="frm_input">
            <span>Code</span> <br />
            <input type="text" name="course_code" id="course_code" value="<%=@course.code if @course%>" class="small" onBlur='javascript:setStorage("course_code", $(this).val());$("#hdn_is_page_change").val(true);' />
          </div>
          <% if @course %>
            <!-- Message -->
            <div id="msg_input" class="message_input hide">
              <label>Message</label> <br />
                <textarea id="msg_content" name="msg_content" cols="15" rows="6"></textarea> <br />
                <span>
                  <input type="button" name="sbmt_msg" class="sbmt_msg" title="msg_content" id="<%=@course.id%>" rel="Course" value="Post" />
                </span>
                &nbsp;
                <span>
                  <a href="javascript:void(0)" onclick="javascript:$('#msg_input').fadeOut()">Cancel</a>
                </span>
            </div>
            <div class="frm_label">
              <input type="button" name="post_msg" id="post_msg" value="Post Message" class="big_btn" onclick="javascript:$('#msg_input').fadeIn()"/>
            </div>
            <div class="frm_input">
              <div id="message_wrapper" class="message_wrapper">
                &nbsp;
                <% if @course.messages %>
                  <% @course.messages.each do |message| %>
                    <%= render :partial => "/message/messages", :locals => {:message=>message} %>
                  <% end %>
                <% end %>
              </div>
            </div>
            <!-- Message ends -->
          <% end %>
        </div>
      </div>
      <div id="div_2" class="form_container hide">
        <div class="frm_label small_label">
          Participants
        </div>
        <div class="frm_input">
          <input type="text" name="add_people_email[]" class="medium" id="add_people_text" /> 
          <input type="button" name="btn_add_people" id="btn_add_people" value="Add" />
          <div class="frm_input" id="add_people_container">
          </div>
        </div>
        <div class="frm_label small_label">
          &nbsp;
        </div>
        <div id="course_people" class="frm_input">
          <% if @peoples %>
            <%= render :partial => "/course/participant_list", :locals => {:peoples=>@peoples, :mode=>"list"} %>
          <% end %>
        </div>
        <div id="participant_list" class="hide">
          <div style="width:40px;height:10px;float:right;padding:2px;">
            <a href="javascript:void(0)" onClick="javascript:$('#participant_list').hide();">Close</a>
          </div>
          <div id="participant_list_inner">
              Loading...
          </div>
        </div>
      </div>
      <div id="div_3" class="form_container hide">
        <div class="frm_label small_label">
          Outcomes
        </div>
        <div class="frm_input">
          <% if @course %>
            <% @course.outcomes.each do |o| %>
              <div style="margin-top:5px;" id="outcome_div_<%=o.id%>">
                <input type="checkbox" name="chk_outcome[]"  id="<%=o.id%>" value="<%=o.id%>" />
                <input type="text" name="loaded_outcomes[]" value="<%= o.name %>" rel="<%=o.id%>" class="medium" /> &nbsp;&nbsp;
              </div>
            <% end %>
          <% end %>
          <div id="add_outcome_container" style="margin:10px 0 0 22px;">
            <input type="text" name="outcomes[]" id="outcomes_1" class="medium" /> &nbsp;&nbsp;
          </div>
        </div>
      </div>
      <div id="div_4" class="form_container hide">
        <div class="frm_label small_label">
          Categories
        </div>
        <div class="frm_input">
          <% if @course %>
            <% @course.categories.each do |c| %>
              <div style="margin-top:10px;" id="category_div_<%=c.id%>">
                <input type="checkbox" name="chk_categories[]"  id="<%=c.id%>" value="<%=c.id%>" />
                <input type="text" name="loaded_categories[]" value="<%= c.name %>" rel="<%=c.id%>" class="medium" /> &nbsp;&nbsp;
              </div>
            <% end %>
          <% end %>
          <div  id="add_category_container" style="margin:10px 0 0 22px;">
            <input type="text" name="categories[]" id="categories_1" class="medium" /> &nbsp;&nbsp;
          </div>
        </div>
      </div>
      <input type="hidden" name="course_id" id="course_id_hdn" value="<%=@course.id if @course%>" />
      <input type="hidden" name="wall_id" id="course_wall_id_hdn" value="<%= @wall.id if @wall && !@wall.nil? %>" />
      <input type="hidden" name="school_id" id="course_school_id_hdn" value="<%= @profile.school_id %>" />
    </form>
  </div>
</div>
<div class="menu_container">
  <div>
    <a href="javascript:void(0)" value="1" class="active">SUMMARY</a>
  </div>
  <div>
    <a href="javascript:void(0)" value="2" id="people_tab" class="sbmt_course" >PEOPLE</a>
  </div>
  <div>
    <a href="javascript:void(0)" value="3" id="outcome_tab"  class="sbmt_course" >OUTCOMES</a>
  </div>
  <div>
    <a href="javascript:void(0)" value="4" id="category_tab" class="sbmt_course" >CATEGORIES</a>
  </div>
</div>
<div id="sidebar_right">
  <div id="crud_level">
    <input type="button" name="btn_course" id="btn_course" class="sbmt_course" value="Save"/>
    <% if @course%>
      <input type="button" name="menu_btn_hide" id="menu_btn_hide" value="Hide"/>
      <input type="button" name="menu_btn_fav" id="menu_btn_fav" value="Fav"/>
      <input type="button" name="menu_btn_print" id="menu_btn_print" value="Print"/>
      <input type="button" name="btn_outcome_remove" id="btn_outcome_remove" class="hide" value="Remove"/>
      <input type="button" name="btn_category_remove" id="btn_category_remove" class="hide" value="Remove"/>
    <% end %>
    <input type="hidden" name="hdn_is_page_change" id="hdn_is_page_change" value="<%=@course ? false : true %>" />
  </div><!-- crud_level -->
</div>
<script type="text/javascript">
<!-- 
jStorage.flush();
//For dynamic added nodes
var _counterPeople = 2;
var _counterOutcome = 2;
var _counterCategory = 2;
var _outcomesObject = [];
var _categoriesObject = [];

//set outcomes to offline storage
$.each($('input[name="outcomes[]"], input[name="people_id[]"], input[name="categories[]"]'), function() {
  //alert($(this).attr('id') +"==="+ $(this).val()) 
  setStorage($(this).attr('id'), $(this).val());
});

//set storage on load while view of course
if($("#course_name").val()!="") {setStorage("course_name", $("#course_name").val());} else {setStorage("course_name", "New Course");}
if($("#course_descr").val()!="") {setStorage("course_descr", $("#course_descr").val());} else {setStorage("course_descr", "New Course Description");}
if($("#course_code").val()!="") {setStorage("course_code", $("#course_code").val());} else {setStorage("course_code", "New Course Code");}

$(document).ready(function(){
  //Toggle Tabs
  $(".menu_container a").unbind('click').bind('click', function(){
    idx = $(this).attr("value");
    $(".menu_container a").removeClass("active");
    $(this).addClass("active");
    for(i=0;i<5;i++){
      if(idx != i){
        $("#div_"+i).hide();
      }
    }
    if(idx == 2) {
      $("#btn_people_remove").fadeIn();
    } else {
     $("#btn_people_remove").hide();
    }
    
    if(idx == 3) {
      $("#btn_outcome_remove").fadeIn();
    } else {
      $("#btn_outcome_remove").fadeOut();
    }
    
    if(idx == 4) {
      $("#btn_category_remove").fadeIn();
    } else {
      $("#btn_category_remove").fadeOut();
    }
    
    $("#div_"+idx).fadeIn();
    is_page_change = $("#hdn_is_page_change").val();
    if(is_page_change=="true") {
      save_course(this.id);
    }
  });
  
  //Submit data
  $("#btn_course").unbind('click').bind('click', function(){
    save_course(this.id);
  });
  
  //For updating outcomes (in course view screen)
  $('input[name="loaded_outcomes[]"]').unbind('blur').bind('blur', function(){
    var outcome_id = $(this).attr('rel');
    var outcome = $(this).val();
    var dataString = 'outcome_id=' + outcome_id + '&outcome=' + outcome
    if(outcome_id) {
      //alert (dataString);return false;
      $.ajax({  
        type: "POST",  
        url: "/course/update_course_outcomes",  
        data: dataString,
        dataType:"json",
        success: function(data) {
          if (data) {
            // To Do
          } else {
            alert("ERROR");
          }
        }
      });  
      return false; 
    }
  });
  
  //For updating categories (in course view screen)
  $('input[name="loaded_categories[]"]').unbind('blur').bind('blur', function(){
    var category_id = $(this).attr('rel');
    var category = $(this).val();
    var dataString = 'category_id=' + category_id + '&category=' + category
    if(category_id) {
      //alert (dataString);return false;
      $.ajax({  
        type: "POST",  
        url: "/course/update_course_categories",  
        data: dataString,
        dataType:"json",
        success: function(data) {
          if (data) {
           // To Do
          } else {
            alert("ERROR");
          }
        }
      });  
      return false; 
    }
  });
  
  //List people (participants)
  $("#btn_add_people").click(function() {
    $("#participant_list").show();
    $("#participant_list_inner").html("Loading...");
    text = $("#add_people_text").val();
    school_id = $("#course_school_id_hdn").val();
    dataString = {school_id:school_id, search_text:text};
    if (school_id && text!="") {
      $.ajax({  
        type: "POST",  
        url: "/course/get_participants",  
        data: dataString,
        success: function(data) {
          if (data) {
            $("#participant_list_inner").html(data);
          } else {
            alert("ERROR");
          }
        }
      }); 
    }
  });
  
  //Add people (participant) to course
  $("#participant_list").delegate(".people_node li", "click", function(){
    course_id = $("#course_id_hdn").val();
    profile_id = $(this).attr("id");
    profile_name = $(this).text();
    node_class = $(this).attr("class");
    dataString = {course_id:course_id, profile_id:profile_id};
    if (profile_id && course_id) {
      $.ajax({  
        type: "POST",  
        url: "/course/add_participant",  
        data: dataString,
        dataType: "json",
        success: function(data) {
          if (data.status) {
            participant_node = $('<li></li>');
            participant_node.class = node_class;
            participant_node.id = profile_id;
            partcipant_html = '<div class="people_name">' + profile_name + '</div>';
            partcipant_html += '<div class="people_delete"><a href="javascript:void(0)">Delete</a></div>';
            participant_node.append(partcipant_html);
            $("#course_people ul").append(participant_node);
            $("#participant_list").hide();
            $("#hdn_is_page_change").val(true);
          } else {
            if(data.already_added) {
              alert("This participant is already added to this course!!");
            } else {
              alert("ERROR");
              $("#participant_list").hide();
            }
          }
        }
      }); 
    }
  });
  
  //Delete participant 
  $(".people_node li").delegate(".people_delete a", "click", function(){
    //alert($(this).attr("rel"));
    profile_id = $(this).attr("rel");
    course_id = $("#course_id_hdn").val(); 
    dataString = {course_id:course_id, profile_id:profile_id};
    if(profile_id) {
      $.ajax({  
        type: "POST",  
        url: "/course/delete_participant",  
        data: dataString,
        success: function(data) {
          if (data) {
            $("#"+profile_id).remove();
          } else {
            alert("ERROR");
          }
        }
      });
    }
  });
  
  //For outcomes node
  $("#add_outcome_container .medium").unbind('focusout').bind("focusout", function(){
    current_node = _counterOutcome - 1;
    val = $("#outcomes_"+current_node).val();
    if(val!="") {
      addNode('outcome');
      $("#hdn_is_page_change").val(true);
      setStorage("outcomes_"+current_node, val);
    }
  });
  
  //Remove outcome nodes
  $("#btn_outcome_remove").unbind('click').bind("click", function(){
    
    var outcome_id = []
    i = 0
    $("input[name='chk_outcome[]']").each(function(){
      if(this.checked) {
        id = $(this).attr('id');
        outcome_id[i] = id;
        i++;
        $("#outcome_div_"+id).remove();
      }
    });
    
    var dataString = 'outcomes='+outcome_id;
    
    $.ajax({  
      type: "POST",  
      url: "/course/remove_course_outcomes",  
      data: dataString,
      dataType:"json",
      success: function(data) {
        
      }
    });  
  });
  
  //For categories node
  $("#add_category_container .medium").unbind('focusout').bind("focusout", function(){
    current_node = _counterCategory - 1;
    val = $("#categories_"+current_node).val();
    if(val!="") {
      addNode('category');
      setStorage("categories_"+current_node, val);
      $("#hdn_is_page_change").val(true);
    }
  });
  
  //Remove category nodes
  $("#btn_category_remove").unbind('click').bind("click", function(){
    
    var category_id = []
    i = 0
    $("input[name='chk_categories[]']").each(function(){
      if(this.checked) {
        id = $(this).attr('id');
        category_id[i] = id;
        i++;
        $("#category_div_"+id).remove();
      }
    });
    
    var dataString = 'categories='+category_id;
    
    $.ajax({  
      type: "POST",  
      url: "/course/remove_course_categories",  
      data: dataString,
      dataType:"json",
      success: function(data) {
        
      }
    });  
  });
  
  //Post Message
  $('.right_form_container').delegate('.sbmt_msg', 'click', function(){
  //$(".sbmt_msg").unbind('click').bind("click", function() {
    parent_id = $(this).attr("id");
    parent_type = $(this).attr("rel");
    text = $(this).attr("title");
    message = $("#"+text).val();
    var dataString = {parent_id:parent_id, parent_type:parent_type, content: message};
    //alert(dataString.content);return false;
    $.ajax({  
      type: "POST",  
      url: "/message/save",  
      data: dataString,
      success: function(data) {
        $("#"+text).val("");
        if(parent_type=="Course") {
          $("#message_wrapper").append(data);
          $("#msg_input").fadeOut();
        } else if (parent_type=="Message") {
          $("#post_comment_"+parent_id).hide();
          $("#messsage_box_"+parent_id).append(data);
        }
      }
    });  
  });
  
  //Like/Unlike a message or comment
  $('.message_wrapper').delegate('.like', 'click', function(){
    if(this.id){
      action = $(this).attr('rel');
      controller = this;
      $.ajax({  
        type: "POST",  
        url: "/message/"+action,
        dataType: 'json',
        data: {message_id:this.id},
        success: function(data) {
          if (data) {
            $(controller).attr('rel',data.action);
            $(controller).text(data.action.toUpperCase());
            $('#count_'+controller.id).html(data.count);
          }
        }
      });
    }
  });
  
  //Uploader task image upload
  var course_uploader = new plupload.Uploader({
    runtimes: 'html5',
    drop_element: 'course_image',
    container: 'course_image',
    max_file_size: '5mb',
    resize : {width : 125, height : 125},
    url: '/course/save',
    multipart_params: {
      'authenticity_token' : token,  //For csrf-authentication
      'school_id' : $("#course_school_id_hdn").val(),
      'id' : $("#course_id_hdn").val()
    },
    filters : [
      {title : "Image files", extensions : "jpg,gif,png,JPG,PNG,GIF,JPEG"}
    ]
  });
  
  course_uploader.init();
  
  course_uploader.bind('FilesAdded', function(up, files) {
    course_uploader.settings.multipart_params.course = getStorage("course_name");
    course_uploader.settings.multipart_params.code = getStorage("course_code");
    course_uploader.settings.multipart_params.descr = getStorage("course_descr");
    course_uploader.start();
  });
  
  course_uploader.bind('UploadProgress', function(up, file) {
    $('#course_image').html('<center>Uploading..</center>');
  });
  
  course_uploader.bind('FileUploaded', function(up, file, info) {
    var obj = jQuery.parseJSON( info.response);
    courseImg = $('<img >').attr('src',obj.image_url);
    course_uploader.settings.multipart_params.id = obj.course.id;
    $('#course_id_hdn').val(obj.course.id);
    $('#course_image').html(courseImg);
  });
  
});

//Save course
function save_course(channel) {
  //Get data from offline storage
  course_id = $("#course_id_hdn").val();
  course = getStorage("course_name");
  descr = getStorage("course_descr");
  code = getStorage("course_code");
  school_id = $("#course_school_id_hdn").val();
  wall_id = $("#course_wall_id_hdn").val();
  
  //get outcomes from offline storage
  k = 0;
  $.each($('input[name="outcomes[]"]'), function() {
    _outcomesObject[k] = getStorage($(this).attr('id'));
    k++;
  });
  
  //get categories from offline storage
  l = 0;
  $.each($('input[name="categories[]"]'), function() {
    _categoriesObject[l] = getStorage($(this).attr('id'));
    l++;
  });
  
  var dataString = 'id='+ course_id +'&course='+ course + '&descr=' + descr + '&code=' + code + '&school_id=' + school_id + '&outcomes=' + _outcomesObject + '&categories=' + _categoriesObject + '&wall_id=' +wall_id;  
  //alert (dataString);return false;  
  $.ajax({
    type: "POST",  
    url: "/course/save",  
    data: dataString,
    dataType:"json",
    success: function(data) {
      if (data) {
        $("#course_id_hdn").val(data.course.id);
        if(channel=="btn_course") {
          $("#container").load('/course/index');
        }
        $("#hdn_is_page_change").val(false);
      } else {
        alert("ERROR");
      }
    }
  });  
  return false;  
}

//Adding text field nodes for peoples, outcomes, categories
function addNode(element) {
  if(element=="people") {
    var newNode = $(document.createElement('div')).attr("id", 'people_node_div' + _counterPeople);
    newNode.css("marginTop" , "20px");
    newNode.html('<input type="text" name="add_people_email[]" value="Type in email to add" class="medium node" id="add_people_email_' + _counterPeople + '" />');
    newNode.appendTo("#add_people_container");
    _counterPeople++;
  } else if(element=="outcome"){
    var newNode = $(document.createElement('div')).attr("id", 'outcome_node_div' + _counterOutcome);
    newNode.css("marginTop" , "20px");
    newNode.html('<input type="text" name="outcomes[]" id="outcomes_' + _counterOutcome + '" value="" class="medium"  />');
    newNode.appendTo("#add_outcome_container");
    _counterOutcome++;
  } else if(element=="category"){
    var newNode = $(document.createElement('div')).attr("id", 'category_node_div' + _counterCategory);
    newNode.css("marginTop" , "20px");
    newNode.html('<input type="text" name="categories[]" id="categories_' + _counterCategory + '" value="" class="medium"  />');
    newNode.appendTo("#add_category_container");
    _counterCategory++;
  }
}
-->
</script>
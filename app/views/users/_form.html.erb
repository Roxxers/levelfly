<div class="leader_content">
  <div class="leader_board_left">
    <div class="leader_board_right">
      <div class="leader_board_center">
        <div class="leader_pad_top"></div>
        <div class="leader_pad">

          <div class="leader_TabCSS">
          <div class="steel_pin"><img src="/images/pin_steel.png" /></div>
          <div class="leader_topselect">
            <div class="clear"></div>
          </div>

          <div class="smaller_avatar" style="margin-left: 100px;">
            <div>
              <div id="modify" class="avat">
                <img id="background" class="smaller_full_avatar">
                <img id="avatar_body" class="smaller_full_avatar">
                <img id="hair_back" class="smaller_full_avatar">
                <img id="shoes" class="smaller_full_avatar">
                <img id="bottom" class="smaller_full_avatar">
                <img id="necklace" class="smaller_full_avatar">
                <img id="top" class="smaller_full_avatar">
                <img id="head" class="smaller_full_avatar">
                <img id="earrings" class="smaller_full_avatar">
                <img id="facial_marks" class="smaller_full_avatar">
                <img id="facial_hair" class="smaller_full_avatar">
                <img id="face" class="smaller_full_avatar">
                <img id="glasses" class="smaller_full_avatar">
                <img id="hair" class="smaller_full_avatar">
                <img id="hat" class="smaller_full_avatar">
                <img id="prop" class="smaller_full_avatar">
              </div>
            </div>

          </div>
          <div style="height:50px;"></div>
           <div id="" class="color_b" style="margin-left: 350px; position: absolute; width: 50%;">
             
              <div class="course_viewfield color_b field_label" style="margin-bottom: 30px;">Full name
                <div class="dd_bg brown_bg">
                  <input type="text" name="user_name" id="user_name" value="<%=@profile.full_name if @profile%>" class="dd_input brown_bg prompted" style="width:100%;"/>
                </div>
              </div>
               
              <div class="course_viewfield color_b field_label" style="margin-bottom: 30px;">Email
                <div class="dd_bg brown_bg">
                  <input type="text" name="user_email" id="user_email" value="<%=@profile.user.email if @profile%>" class="dd_input brown_bg prompted" style="width:100%;"/>
                </div>
              </div>
              
              <div class="course_viewfield color_b field_label" style="margin-bottom: 30px;">Password
                <div class="dd_bg brown_bg">
                  <input  name="user_password" id="user_password" value="" class="dd_input brown_bg prompted" type="password" style="width:100%;"/>
                </div>
              </div>
              <div style="height:20px;"></div>
              
              <div class="course_viewfield color_b field_label">This user may:
                <div class=""></br>
                  <input type="checkbox" name ="user_role[]" class="check_box" id="create_course" <%= @profile && Role.check_permission(@profile.id, "C") ? "checked='checked'" : "" %>value=""/> Modify Courses</br></br>
                  <input type="checkbox" class="check_box" name ="user_role[]" id="create_group" <%=@profile && Role.check_permission(@profile.id, "G") ? "checked='checked'" : "" %>value=""/> Modify Groups</br></br>
                  <input type="checkbox" class="check_box" name ="user_role[]" id="create_task" <%=@profile && Role.check_permission(@profile.id, "T") ? "checked='checked'" : "" %>value=""/> Modify Tasks</br></br>
                  <input type="checkbox" class="check_box" name ="user_role[]" id="edit_grade" <%=@profile && Role.check_permission(@profile.id, Role.edit_grade) ? "checked='checked'" : "" %>value=""/> Modify Grades</br></br>
                  <input type="checkbox" class="check_box" name ="user_role[]" id="edit_user" <%=@profile && Role.check_permission(@profile.id, Role.edit_user) ? "checked='checked'" : "" %>value=""/> Modify Users</br></br>
                  <input type="checkbox" class="check_box" name ="user_role[]" id="modify_rewards" <%=@profile && Role.check_permission(@profile.id, Role.modify_rewards) ? "checked='checked'" : "" %>value=""/> Modify Rewards</br></br>
                  <input type="checkbox" class="check_box" name ="user_role[]" id="modify_wardrobe" <%=@profile && Role.check_permission(@profile.id, Role.modify_wardrobe) ? "checked='checked'" : "" %>value=""/> Modify Wardrobe</br></br>
                  <input type="checkbox" class="check_box" name ="user_role[]" id="modify_settings" <%=@profile && Role.check_permission(@profile.id, Role.modify_settings) ? "checked='checked'" : "" %>value=""/> Modify Settings</br></br>
                </div>
              </div>
              <div class="clear"></div>
              </br>
              <div class="course_viewfield color_b field_label">This user is:
                 <div class=""></br>
                  <input type="radio" name="user_status[]" checked="true" value="" rel="A" /><span> Active 
                  </span>
                  &nbsp; &nbsp;
                  <input type="radio" name="user_status[]" <%if @profile and @profile.user.status=="S" %>checked="true"<%end%>  rel="S" value=""/><span> Suspended</span>
                </div> 
            </div>   
            </div>          
          </div>  
        </div>
        <div class="end_of_page" style="height:600px;"></div>
      </div>
    </div>
  </div>

  <div id="sidebar_right">
    <div class="course_side_buttons">
        <a class="big_blue_btn" name="save_user_btn" id="save_user_btn" href="javascript:void(0)">SAVE</a>
    </div><!-- crud_level -->
  </div>
<input type="hidden" name="user_id" id="user_id_hdn" value="<%=@profile.id if @profile%>" />
<input type="hidden" name="avtr" id="avtr" value="<%=@avatar if @avatar%>" />

<script type="text/javascript">
  var roles_assign = [];
  var roles_name = [];
  var _avatar;
  $(document).ready(function(){
    $("#save_user_btn").click(function(){
      var valid = false
      valid = validate_form()
      if(valid==true){
         $.each($('input[name="user_status[]"]'), function(){
          /*status = $(this).is(":checked");*/
          if ($(this).is(":checked")){
            user_status = $(this).attr("rel");
          }
        });
        var id = $("#user_id_hdn").val();
        var email = $("#user_email").val();
        var name = $("#user_name").val();
        var user_password = $("#user_password").val();
         j = 0;
        $.each($('input[name="user_role[]"]'), function() {
           roles_assign[j] = this.checked;
           roles_name[j] = this.id;
           j++;   
        });
        if (user_password =="")
          var datastring = "id="+id+"&name="+name+"&email="+email+"&roles_assign="+roles_assign+"&roles_name="+roles_name+"&status="+user_status
        else
          var datastring = "id="+id+"&name="+name+"&email="+email+"&user_password="+user_password+"&roles_assign="+roles_assign+"&roles_name="+roles_name+"&status="+user_status
        showSpinner(true);
        $.ajax({
        type:"POST",
        dataType :"json",
        url:"/users/save/",
        data:datastring,
        success: function(data){
          if (data.status==true){
            $("#container").load('/users/', function(){
              showSpinner(false);
            });
          }
          else if(data.email_exist==true){
             showSpinner(false);
             alert("emial already exist");
          }
            showSpinner(false);
        },
        error : function(){
          alert("ERROR");
          showSpinner(false);
        }
        });
      }
  });
  <%if @profile and !@profile.nil?%>
    loadWardrobe();
   <% end %>
});

function loadWardrobe() {
   jStorage.flush();
   var profile_user_id = $("#user_id_hdn").val();
   if (profile_user_id) {
     data = {id:profile_user_id}
   } else {
     data = {}
   }

  $.getJSON("/profile/show", data,
      function(data){
        _profile = data.profile;
        _avatar = data.avatar;
        _major = data.major;
        _school = data.school;
        h[profile_user_id]=data.avatar;
        if (data.new_profile == true) {
          acceptCode();
        }
        jStorage.flush()
        jStorage.set("j_profile",data.profile);
        jStorage.set("j_avatar",data.avatar);
        jStorage.set("j_major",data.major);
        //jStorage.set("j_school",data.school);
        showFullAvatar();
      }
   ).error(function() { 
     alert("Showing from stograge");
     _profile = jStorage.get("j_profile");
     _avatar = jStorage.get("j_avatar");
     _major = jStorage.get("j_major");
     //_school = jStorage.get("j_school");
   });
}

function showFullAvatar() {
  $("#background").attr("src", "/images/wardrobe/"+_avatar.background+".png");
  $("#avatar_body").attr("src", "/images/wardrobe/"+_avatar.body+".png"); //Id changed by vaibhav because having id "body" is creating problem with jQuery.position()
  // $("#hat_back").attr("src", "/images/wardrobe/"+_avatar.hat_back+".png");
  $("#hair_back").attr("src", "/images/wardrobe/"+_avatar.hair_back+".png");
  $("#shoes").attr("src", "/images/wardrobe/"+_avatar.shoes+".png");
  $("#bottom").attr("src", "/images/wardrobe/"+_avatar.bottom+".png");
  $("#necklace").attr("src", "/images/wardrobe/"+_avatar.necklace+".png");
  $("#top").attr("src", "/images/wardrobe/"+_avatar.top+".png");
  $("#head").attr("src", "/images/wardrobe/"+_avatar.head+".png");
  $("#earrings").attr("src", "/images/wardrobe/"+_avatar.earrings+".png");
  $("#facial_marks").attr("src", "/images/wardrobe/"+_avatar.facial_marks+".png");
  $("#facial_hair").attr("src", "/images/wardrobe/"+_avatar.facial_hair+".png");
  $("#face").attr("src", "/images/wardrobe/"+_avatar.face+".png");
  $("#glasses").attr("src", "/images/wardrobe/"+_avatar.glasses+".png");
  $("#hair").attr("src", "/images/wardrobe/"+_avatar.hair+".png");
  $("#hat").attr("src", "/images/wardrobe/"+_avatar.hat+".png");
  $("#prop").attr("src", "/images/wardrobe/"+_avatar.prop+".png");
  
}

function validate_form(){
  var user_password = document.getElementById("user_password");
  var email=document.getElementById("user_email").value;
  var atpos=email.indexOf("@");
  var dotpos=email.lastIndexOf(".");
 
  if (email==""){
      alert('Enter Email Address');
      return false;
  }
  else if (atpos<1 || dotpos<atpos+2 || dotpos+2>=email.length)
  {
  alert("Not a valid e-mail address");
  return false;
  }

  if(user_password.value==""){
    if ($("#user_id_hdn").val()==""){
      alert("Enter password")
      user_password.focus();
     return false;
     }
    else
    return true;
  }
  else if(user_password.value.length < 6 ){
    alert("Password have minimum 6 character");
    user_password.focus();
    return false;
  }
  return true;
}
</script>